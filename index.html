<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3: A starting point for interactivity</title>
    <script type="text/javascript" src="js/d3.v3.js"></script>
    <script type="text/javascript" src="js/underscore.js"></script>
    <script type="text/javascript" src="js/graph-scroll.js"></script>
    <script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
    <!-- https://1wheel.github.io/graph-scroll/ -->
    <style type="text/css">
      body{
        width: 960px;
        height: 4000px;
        margin: 0px auto;
        background-color: '#E1E3D8';
        color: '#1A1A1A';
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      }

      #container {
        position: relative;
        width: 100%;
        overflow: auto;
      }

      #sections {
        float: left;
      }

      #sections > div{
        background: white;
        opacity: .2;
        margin-bottom:120px;
      }

      #sections > div.graph-scroll-active, #sections2 > div.graph-scroll-active{
        opacity: 1;
      }


      #graph {
        position: fixed;
        top: 220px;
      }

      #graph.graph-scroll-fixed, #graph2.graph-scroll-fixed{
        position: fixed;
      }

      h1 {
        margin: 50px;
      }

      h1, h3{
        text-align: center;
      }

      .mono{
        font-family: monospace;
      }

      div.section {
        height: 400px;
      }

      text.pixelvalue {
        font-size: 1px;
        text-align: right;
      }
      .button {
        opacity: 0.1;
        float: right;
      }

      .button-active {
        opacity: 1;
        color: #FCAE0C; /*yellow*/
        cursor: pointer;
        font-weight: 900;
      }

      .red {
        color: #F12A1B;
      }
    </style>
  </head>
  <body>
    <h1>Classification of MNIST Hand-Drawn Digits</h1>
      <div id='container'>
          <div id='sections'>
            <div class='section' id='section-1'>
              <p><b>The image classification challenge:</b> Many machine learning tasks are concerned with classification. A common example is classifying images, whether the images be a photo of a cat or a hand-written digit. Converting hand-writing to computer-readable characters has many useful applications; for example, parsing a doctor's hand-written notes for electronic storage and future analysis.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-2'>
              <p>But computers are simple creatures and it's hard for them to understand an image. Images have to be decomposed into lists of numeric values.</p>
              <p>A large set of examples is often required to train a classifier. These lists and their labels are the <b>training data</b> in classification tasks.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-3'>
              <p>When a <span style="class: 'red';">new object</span> needs to be classified, classification methods use the training data to determine which class is most likely for the new data. A classic and intuitive classification method is called <b>nearest-neighbors classification</b>. When an unknown image needs to be classified, it is compared to a training set. For each item in the training set, the new image is given a <b>distance score</b>. Those items in the training set which are "closest" to the new image are used to classify the new image.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-4'>
              <p>When a <span style="class: 'red';">new object</span> needs to be classified, classification methods use the training data to determine which class is most likely for the new data. A classic and intuitive classification method is called <b>nearest-neighbors classification</b>. When an unknown image needs to be classified, it is compared to a training set. For each item in the training set, the new image is given a <b>distance score</b>. Those items in the training set which are "closest" to the new image are used to classify the new image.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-5'>
              <p>Predictions for the class of the new observation are made on the basis of the distance from objects in the training set.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-6'>
              <p>Predictions for the class of the new observation are made on the basis of the distance from objects in the training set.</p>
              <div class='button'>Continue</div>
            </div>

            <div class='section' id='section-7'>
              <p>With few examples, many classification algorithms have a hard time making the right predictions. However, we humans are much better at this type of thing. We know how to recognize common shapes so we understand new examples easily.</p>
              <div class='button'>Back to top</div>
            </div>            
          </div>

        <div id='graph'></div>
    </div>
  </body>

  <footer>
    <script type="text/javascript">
      d3.selectAll('.button').on('click', function(button) {
        $('.button-active').attr('class', 'button')
        var current = parseInt(d3.select(this.parentNode).attr('id').split('-')[1])

        if (!(current == $('.section').length)) {
          $('html, body').animate({
              scrollTop: $("#section-" + (current + 1)).offset().top- 80
          }, 2000);
        } else {
          setup()
          $('html, body').animate({
              scrollTop: $("#section-1").offset().top - 80
          }, 2000);       
        }
      })

      //Width and height
      var w = 960;
      var h = 400;
      
      //Create SVG element
      var svg = d3.select("#graph")
            .append("svg").attr({width: w, height: h})

      var pixelsize = 3.85
      var numpixels = 255
      var imgwidth = pixelsize*16
      var subset_size = Math.floor((960-imgwidth)/imgwidth)

      var pixelscale = d3.scale.linear()
        .domain([0,16])
        .range([0,imgwidth]);

      var vectorscale = d3.scale.linear()
        .domain([0,255])
        .range([0,numpixels*pixelsize]);

      var black = '#1A1A1A'
      var blackwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([black,'white']);

      var red = '#F12A1B'
      var redwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([red,'white']);

      var blue = '#0AB3A4'
      var bluewhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([blue,'white']);  

      var setup = function() {
        d3.selectAll('rect').remove()
        d3.selectAll('g').remove()
        d3.selectAll('text').remove()
        d3.csv("data/MNIST_training.csv", function(data) {
          // we don't need all the data
          // TODO: Randomize?        
          subset = data.slice(0,subset_size)
          newdigit = data[subset_size]
          subset.map(function(d) {
            _.map(d, function(v, k) { d[k] = +v })
          })

          _.map(newdigit, function(v,k) {
            newdigit[k] = +v
          })

          newDigitGroup = svg.append("svg:g")
            .attr('class', 'newdigitgroup')
            .attr('id', 'newdigit_' + newdigit.label)
            .attr("transform", function(d) { return "translate(0,20)"; })

          newDigitGroup.append('svg:text')
            .attr('id', 'newdigitvalues_header')

          newDigitGroup.selectAll(".pixelvalue")
              .data(_.values(newdigit))
            .enter().append("text")
              .attr("class", "pixelvalue")

          newDigitGroup.selectAll(".pixel")
              .data(_.values(newdigit))
            .enter().append("rect")
                .attr('class', 'pixel')

          newDigitDefaults();

          var trainingGroup = svg.append('svg:g')
            .attr('class','trainingSetGroup')
            .attr("transform", function(d) { return "translate(0," + 30 + ")"; })

          trainingGroup.append('svg:text').text('Training Set')
             .style('fill',blue)
             .style('font-weight', 900)
             .attr('y', -12)

          // Put digits, numeric values and new digit on the page
          // when certain sections are active animate in and out of view
          //
          // Plot each from the subset
          // for each object, append a group to svg
          // and then plot each point from the digit
          subset.forEach(function(digit, idx) {
            digitGroup = trainingGroup.append("svg:g")
              .attr('class', 'digit_group')
              .attr('id', 'digit' + idx + '_' + digit.label)

            digitGroup.selectAll(".pixel")
                .data(_.values(digit).slice(0,256))
              .enter().append("rect")
                .attr("class", "pixel group-" + idx)

            digitGroup.selectAll(".pixelvalue")
                .data(_.values(digit).slice(0,256))
              .enter().append("text")
                .attr('class', 'pixelvalue')
          });
          trainingGroupDefaults();
          pixelValueDefaults();

          drawTraining(0);

          distancesGroup = svg.append("svg:g")
            .attr('id', 'distances_group')
            .attr("transform", function(d) { return "translate(0,0)"; })

          distancesGroup.append('svg:text')
            .attr('id','distance-header')
            .text('Distance from new observation:')
            .style('font-weight', 900)

          var sums = [];
          // take each object and subtract it from the new object
          subset.forEach(function(trainingdigit, digit_idx) {
            var pairs = _.zip(_.values(trainingdigit), _.values(newdigit))
            
            var sum = _.reduce(pairs, function(memo, num){ return memo + Math.pow(num[0] - num[1], 2); }, 0);
            sums.push(sum)
            // shift the group down and spit out a value
            distancesGroup.append("svg:text")
                .attr('class', 'distance-text')
                .attr('id', 'distance-' + digit_idx)
                .text(Math.round(sum))     
          })

          distancesGroupDefaults();
          var subset_nn = _.indexOf(sums, _.min(sums))
        });
      }
      setup();

      var newDigitDefaults = function() {
        d3.selectAll('#newdigitvalues_header')
          .text('New observation')
          .style('font-weight', 900)
          .attr('fill', red)
          .style('fill-opacity', 1e-6)

        var newDigitGroup = svg.selectAll('.newdigitgroup')

        newDigitGroup.selectAll(".pixelvalue")
            .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
            .attr("y", 12)
            .text(function(d) { return Math.round(d * 10)/10 })
            .style('fill-opacity', 1e-6)
            .style('fill', red)
            .style('font-weight', 900)
            .style('font-size', '7px')

        newDigitGroup.selectAll('.pixel')
          .attr("width", pixelsize)
          .attr("height", pixelsize)
          .attr("x", function(d,i) {return pixelscale(i%16) + imgwidth*subset_size;})
          .attr("y", function(d,i) {return pixelscale(Math.floor(i/16))+60;})
          .style("fill", function(d) {return redwhitescale(d)})         
          .style('fill-opacity', 1e-6)
      }

      var trainingGroupDefaults = function() {
          d3.select('.trainingSetGroup')
            .attr("transform", function(d) { return "translate(0," + 30 + ")"; })

          var digitGroups = d3.selectAll('.digit_group')
          digitGroups.each(function(group, idx) {
            d3.select(this).selectAll(".pixel")
              .attr("class", "pixel group-" + idx)
              .attr("width", pixelsize)
              .attr("height", pixelsize)
              .attr("x", function(d,i) { return idx*imgwidth  + pixelscale(i%16);})
              .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
              .style('fill-opacity', 1e-6);
         })
      }

      var pixelValueDefaults = function() {
          var digitGroups = d3.selectAll('.digit_group')
          digitGroups.each(function(group, idx) {
            d3.select(this).selectAll(".pixelvalue")
                .attr("class", "pixelvalue")
                .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
                .attr("y", function(d,i) { return pixelscale(idx*2.5) + 5; })
                .text(function(d) { return Math.round(d * 10)/10 })
                .style('fill-opacity', 1e-6)
                .style('font-size', '1px');
         }) 
      }

      var distancesGroupOffset = imgwidth*2
      var distancesGroupDefaults = function() {
        d3.selectAll('#distances_group')
          .attr("transform", function(d) { return "translate(0," + distancesGroupOffset + ")"; })

        d3.selectAll('#distance-header')
          .text('Distance from new observation:')
          .attr('x', 0)
          .attr('y', 0)
          .style('font-size', '12px')
          .style('fill', blue)
          .style('font-weight', 9000)
          .style("fill-opacity", 1e-6);

        d3.selectAll('.distance-text')
          .attr('x', 0)
          .attr("y", function(d,i) { return pixelscale(i*2.5)+35-distancesGroupOffset })
          .style('font-size', '7px')
          .style('fill', black)
          .style('font-weight', 100)
          .style("fill-opacity", 1e-6); 
      }

      var drawTraining = function(delay) {
        var digitgroups = d3.selectAll('.digit_group')

        digitgroups.each(function(group, groupidx) {
            d3.selectAll('.group-' + groupidx).transition()
                .delay(delay)
                .duration(1000)
                .attr("x", function(d,i) {return groupidx*imgwidth + pixelscale(i%16);})
                .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
                .style('fill', function(d) { return blackwhitescale(d)})
                .style('fill-opacity', 1);
            });        
      }

      var dur = 10
      var drawPixelValueVectors = function() {
        subset = d3.selectAll('.digit_group')
        subset.each(function(digit, subset_idx) {
          d3.select(this).selectAll('.pixel').transition()
            .delay(function(d,pix) {return dur*(pix+1)})
            .duration(dur)
            .ease('linear')
            .style('fill', function(d) { return blackwhitescale(d) })
            .attr('x', function(d,i) { return(vectorscale(i)) })
            .attr('y', function(d,i) { return(pixelscale(subset_idx)) })
        });            
      }

      var drawNewDigitValues = function() {
        var newdiggroup = d3.selectAll('.newdigitgroup')
        var subset = d3.selectAll('.digit_group')

        newdiggroup.selectAll(".pixelvalue")
            .transition()
            .duration(1000)
            .style('fill-opacity',1)
            .style('font-size', '7px')
       
        d3.selectAll("#newdigitvalues_header")
            .transition()
            .duration(1000)
            .style('fill-opacity',1) 
      }

      var writeDistances = function() {
          d3.selectAll('#distance-header').transition()
            .delay(2000)
            .duration(1000)
            .style('fill-opacity', 1)

          d3.selectAll('.distance-text').transition()
            .delay(2000)          
            .duration(1000)
            .style('fill-opacity', 1)
            .transition()
              .duration(1000)
              .attr('y', 20)
            .transition()
              .duration(1000)
              .attr('x', function(d,i) { return i*imgwidth+13 })
            .transition()
              .duration(1000)
              .style('font-size', '12px')       
      }
     

      var lastScrollTop = 0;
      var st = 0;
      $(window).scroll(function(event){
         st = $(this).scrollTop();
      });
      graphScroll()
          .graph(d3.selectAll('#graph'))
          .container(d3.select('#container'))
        .sections(d3.selectAll('#sections > div'))
        .on('active', function(i){
          if (i == 0) { activateSectionOne() }
          if (i == 1 && st > lastScrollTop) { activateSectionTwo() }
          if (i == 2 && st > lastScrollTop) { activateSectionThree() }
          if (i == 3 && st > lastScrollTop) { activateSectionFour() }
          if (i == 4 && st > lastScrollTop) { activateSectionFive() }
          if (i == 5 && st > lastScrollTop) { activateSectionSix() }
          if (i == 6) { activateSectionSeven() }
          lastScrollTop = st;
        }) 

        var activateSectionOne = function() {
          d3.selectAll('#section-1 div.button').transition()
            .delay(1000)
            .attr('class','button button-active')
        }

        var activateSectionTwo = function() {
          pixelValueDefaults();
          drawPixelValueVectors();
          d3.selectAll('#section-2 div.button')
            .transition()
            .delay(dur*256+1100).attr('class','button button-active')
        }

        var activateSectionThree = function() {
          pixelValueDefaults();

          d3.selectAll('.digit_group').selectAll('.pixel')
            .transition()
              .delay(function(d,pix) {return dur*pix})
              .duration(1000)
              .ease('linear')
              .style('fill-opacity',1e-6)          
          d3.selectAll('.digit_group').selectAll('.pixelvalue')
            .transition()
              .delay(200*dur)
              .duration(1000)
              .ease('linear')
              .style('fill-opacity',1)
              .style('font-size', '7px')

          d3.selectAll('#section-3 div.button')
            .transition()
            .delay(2000).attr('class','button button-active')
        }        

        var activateSectionFour = function() {
          d3.selectAll('.trainingSetGroup')
            .transition()
            .duration(1000)
            .attr("transform", function(d) { return "translate(0," + 80 + ")"; })
          drawNewDigitValues();

          d3.selectAll('#section-4 div.button')
            .transition()
            .delay(1000)
            .attr('class','button button-active')
        }

        var activateSectionFive = function() {
          d3.selectAll('.digit_group').selectAll('text').transition()
            .duration(2000)
            .attr('x', 0)
            .style('fill-opacity', 1e-6)

        d3.selectAll('#distances_group')
          .attr("transform", function(d) { return "translate(0," + (50 + distancesGroupOffset) + ")"; })

          writeDistances();
          drawTraining(6000);

          d3.selectAll('#section-5 div.button').transition()
            .delay(7000)
            .attr('class','button button-active')           
        }

        var activateSectionSix = function() {
          var magic = 6
          d3.selectAll('.group-' + magic).transition()
              .delay(1000)   
              .duration(1000)
              .ease('linear')
              .style('fill', function(d) { return bluewhitescale(d) });

          d3.selectAll('#distance-' + magic).transition()
            .delay(1000)
            .duration(1000)
            .ease('linear')
            .style('fill', blue)
            .style('font-weight', 900)

            // plot the new digit
            d3.selectAll('.newdigitgroup').selectAll('.pixel')
              .transition()
              .delay(1000)
              .duration(1000)
              .style('fill-opacity', 1)

          d3.selectAll('#section-6 div.button').transition()
            .delay(2000)
            .attr('class','button button-active') 
        }

        var activateSectionSeven = function() {
          // newDigitDefaults();
          // trainingGroupDefaults();
          // pixelValueDefaults();
          // distancesGroupDefaults();

          // drawTraining(0);
          setup();
          var digit_idx = 4
          var pixels = d3.selectAll('.group-' + digit_idx)

          pixels.transition()
              .delay(1000)   
              .duration(1000)
              .ease('linear')
              .style('fill', function(d) { return bluewhitescale(d) });

          var points = []
          pixels[0].forEach(function(pix) {
            if (pix.__data__ > 0.7) {
              point = d3.select(pix)
              points.push([point.attr('x'), point.attr('y')])
            }
          })

          points = points.slice(0,points.length/2)
          points = _.sortBy(points, function(p) {return +p[0]}).reverse()
          points = _.partition(points, function(p,i) {return i%3})[1];
          var valueline = d3.svg.line()
            .interpolate("basis")
            .x(function(d) { return d[0] })
            .y(function(d) { return d[1] });
          var digitpath = svg.append("path")
            .attr("d", valueline(points))
            .attr('class', 'highlighted-digit')
            .attr('transform', 'translate(0,30)')
            .attr("stroke", red)
            .attr("stroke-width", 1e-6)
            .attr("fill", "none")

          d3.selectAll('.highlighted-digit').transition()
              .delay(1000)
              .duration(2000)
              .style('stroke-width', 1)         
        }   
    </script>
  </footer>
</html>

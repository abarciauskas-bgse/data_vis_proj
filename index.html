<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>MNIST Data Visualization</title>
    <script type="text/javascript" src="js/d3.v3.js"></script>
    <script type="text/javascript" src="js/underscore.js"></script>
    <script type="text/javascript" src="js/graph-scroll.js"></script>
    <script type="text/javascript" src="js/jquery-1.12.3.min.js"></script>
    <!-- https://1wheel.github.io/graph-scroll/ -->
    <style type="text/css">
      body{
        width: 960px;
        height: 4100px;
        margin: 0px auto;
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      }

      #container {
        position: relative;
        width: 100%;
        overflow: auto;
      }

      #sections {
        float: left;
      }

      #sections > div{
        background: white;
        opacity: .2;
        margin-bottom:120px;
      }

      #sections > div.graph-scroll-active, #sections2 > div.graph-scroll-active{
        opacity: 1;
      }


      #graph {
        position: fixed;
        top: 460px;
      }

      #graph.graph-scroll-fixed, #graph2.graph-scroll-fixed{
        position: fixed;
      }

      h1 {
        margin: 50px;
      }

      h1, h3{
        text-align: center;
      }

      .mono{
        font-family: monospace;
      }

      div.section {
        height: 300px;
      }

      .section p {
        width: 66.67%;
        float: left;
      }

      text.pixelvalue {
        font-size: 1px;
        text-align: right;
      }
      .button {
        opacity: 0.1;
        float: right;
        margin-top: 1em;
      }

      .button-active {
        opacity: 1;
        color: #0AB3A4; /*blue*/
        cursor: pointer;
        font-weight: 900;
        text-decoration: underline;
      }

      .red {
        color: #F12A1B;
      }

      .blue {
        color: #0AB3A4;
      }

      .yellow {
        color: #FCAE0C 
      }

      b {
        color: #FCAE0C;
      }

      img {
        height: 200px;
        margin-right: 20px;
        float: left;
      }
    </style>
  </head>
  <body>
    <h1 class='yellow'>Classification of MNIST Hand-Drawn Digits</h1>
      <div id='container'>
          <div id='introduction'>
            <h2>Introduction</h2>
            <p><b>The image classification challenge:</b> Many machine learning tasks are concerned with classification. A common example is classifying images, whether the images be a photo of a cat or a hand-written digit. Converting hand-writing to computer-readable characters has many useful applications; for example, parsing a doctor's hand-written notes for electronic storage and future analysis.
            </p>
            <p>
              Many contemporary machine learning algorithms, like <b>the neareast-neighbors algorithm,</b> rely on a large set of examples for predicitve power. However, many new machine learning methodologies are leveraging an understanding of human intuition to improve how machines perform at classification tasks which have few examples.
            </p>
            <p>
              Below I highlight the popular, simple and powerful <b>neareast-neighbors algorithm</b> applied to the MNIST hand-written digit classification challenge, and introduce how <b><a href='http://science.sciencemag.org/content/350/6266/1332' class='blue'>Bayesian Program Learning</a></b> is being used to tackle the same tasks. The motivating research paper focused on the <b><a href='http://omniglot.com/' class='blue'>omniglot dataset</a></b>.
            </p>
          </div>
          <div id='sections'>
            <div class='section' id='section-1'>
              <div class='button'>Continue</div>
              <p>The MNIST dataset of hand-drawn integers is comparable to the omniglot dataset of hand-drawn alphabetic characters in that it includes many examples with a high degree of variation. It is the variation across two-dimensions which makes the classification difficult.</p>            
            </div>

            <div class='section' id='section-2'>
              <div class='button'>Continue</div>
              <p>But computers are simple creatures and it's hard for them to understand an image. Images have to be decomposed into simple data structures and a <b>large set of examples</b> is often required to train a classifier. These examples and their labels are the <b>training set</b> in classification tasks.</p>          
            </div>

            <div class='section' id='section-3'>
              <div class='button'>Continue</div>
              <p>A classic and intuitive classification method is called <b>nearest-neighbors classification</b>. Neareset neighbors uses the <b>pixel values</b> of an image in a list form to find examples which are similar to new unlabeled examples.</p>
            </div>

            <div class='section' id='section-4'>
              <div class='button'>Continue</div>
              <p>When a <b><span class='red'>new example</span></b> needs to be classified, classification methods use the training data to determine which class is most likely for the new data.  The <b><span class='red'>new example</span></b> is compared to the training set.</p>
            </div>

            <div class='section' id='section-5'>
              <div class='button'>Continue</div>
              <p>For each item in the training set, the new image is given a <b>distance score</b>. Those items in the training set which are "closest" to the new image are used to classify the new image.</p>
            </div>

            <div class='section' id='section-6'>
              <div class='button'>Continue</div>
              <p>Predictions for the class of the new observation are made on the basis of the distance from objects in the training set. With few examples, many classification algorithms have a hard time making the right predictions.</p>
            </div>

            <div class='section' id='section-7'>
              <div class='button'>Continue</div>
              <p><b>Humans</b>, however, can classify new observations after just one example. We recognize <b>common shapes and spatial relationships</b> better than current machine learining algorithms.</p>
              <p>Below is an example of a machine's <b>first attempt to mimick hand writing</b>.</p>
            </div> 

            <div class='section' id='section-8'>
              <div class='button'>Learn more</div>
              <p>Researchers are incorporating ideas about how the human brain learns into new methodologies of machine learning called <b><span class='red'>Bayesian Program Learning</span></b>. Bayesian Program Learning learns common strokes of alphabets and has demonstrated strong performance in classification and creative tasks.</p>
              <div style='clear:left;'></div>
              <img src='img/char_parsing.png'/>
              <img src='img/nonparam_bpl.png'/>
              <p>Images courtesy of Science Magazein, see <a href='#section-9'>resources</a> for more information.</p>
            </div>
            <div class='section' id='section-9'>
              <div class='button'>Back to top</div>
              <h2>Resources</h2>
              <ul>
                <li><a href='http://science.sciencemag.org/content/sci/350/6266/1332.full.pdf'>Science Magazine: Human-level concept learning through probabilistic program induction</a></li>
                <li><a href='https://github.com/brendenlake/BPL'>BPL on github</a></li>
                <li><a href='https://en.wikipedia.org/wiki/Bayesian_programming'>Bayesian Programming on Github</a></li>
                <li><a href='http://science.sciencemag.org/content/sci/suppl/2015/12/09/350.6266.1332.DC1/Lake-SM.pdf'>Full paper</a></li>                
              </ul>
            </div>            
          </div>

        <div id='graph'></div>
    </div>
  </body>

  <footer>
    <script type="text/javascript">
      d3.selectAll('.button').on('click', function(button) {
        $('.button-active').attr('class', 'button')
        var current = parseInt(d3.select(this.parentNode).attr('id').split('-')[1])

        if (!(current == $('.section').length)) {
          $('html, body').animate({
              scrollTop: $("#section-" + (current + 1)).offset().top - 70
          }, 1000);
        } else {
          $('html, body').animate({
              scrollTop: $("#section-1").offset().top - 460
          }, 1000);       
        }
      })

      //Width and height
      var w = 960;
      var h = 400;
      
      //Create SVG element
      var svg = d3.select("#graph")
            .append("svg").attr({width: w, height: h})

      var pixelsize = 3.85
      var numpixels = 255
      var imgwidth = pixelsize*16
      var subset_size = 10

      var pixelscale = d3.scale.linear()
        .domain([0,16])
        .range([0,imgwidth]);

      var vectorscale = d3.scale.linear()
        .domain([0,255])
        .range([0,numpixels*pixelsize]);

      var black = '#1A1A1A'
      var blackwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([black,'white']);

      var red = '#F12A1B'
      var redwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([red,'white']);

      var blue = '#0AB3A4'
      var yellowwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([blue,'white']);  

      var yellow = '#FCAE0C'
      var yellowwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([yellow,'white']);        
      var idcs = null;
      var setup = function() {
        d3.selectAll('rect').remove()
        d3.selectAll('g').remove()
        d3.selectAll('text').remove()
        d3.selectAll('path').remove()

        d3.csv('data/train-idcs.csv', function(idcs) {

          var pathsGroup = svg.append("svg:g")
            .attr('class', 'pathsGroup')
            .attr('transform', "translate(0," + trainingGroupOffset + ")")
          idcs = _.map(_.values(idcs), function(i) { return +i['x'] })

          d3.csv("data/MNIST_training.csv", function(data) {
            subset = _.filter(data, function(row,i) { 
              return !(idcs.indexOf(i) == -1)
            });

            newdigit = data[subset_size]
            subset.map(function(d) {
              _.map(d, function(v, k) { d[k] = +v })
            })

            _.map(newdigit, function(v,k) {
              newdigit[k] = +v
            })

            newDigitGroup = svg.append("svg:g")
              .attr('class', 'newdigitgroup')

            newDigitGroup.append('svg:text')
              .attr('id', 'newdigitvalues_header')

            newDigitGroup.selectAll(".pixelvalue")
                .data(_.values(newdigit))
              .enter().append("text")
                .attr("class", "pixelvalue")

            newDigitGroup.selectAll(".pixel")
                .data(_.values(newdigit))
              .enter().append("rect")
                  .attr('class', 'pixel')

            newDigitDefaults();

            var trainingGroup = svg.append('svg:g')
              .attr('class','trainingSetGroup')

            trainingGroup.append('svg:text').text('Training Set')
               .style('fill',yellow)
               .style('font-weight', 900)
               .attr('y', -12)

            // Put digits, numeric values and new digit on the page
            // when certain sections are active animate in and out of view
            //
            // Plot each from the subset
            // for each object, append a group to svg
            // and then plot each point from the digit
            subset.forEach(function(digit, idx) {
              digitGroup = trainingGroup.append("svg:g")
                .attr('class', 'digit_group')
                .attr('data-label', digit.label)
                .attr('id', 'digit' + idx + '_' + digit.label)

              digitGroup.selectAll(".pixel")
                  .data(_.values(digit).slice(0,256))
                .enter().append("rect")
                  .attr("class", "pixel group-" + idx)

              digitGroup.selectAll(".pixelvalue")
                  .data(_.values(digit).slice(0,256))
                .enter().append("text")
                  .attr('class', 'pixelvalue')
            });
            trainingGroupDefaults();
            pixelValueDefaults();

            drawTraining(0);

            distancesGroup = svg.append("svg:g")
              .attr('id', 'distances_group')
              .attr("transform", function(d) { return "translate(0,0)"; })

            distancesGroup.append('svg:text')
              .attr('id','distance-header')
              .text('Distance from new observation:')
              .style('font-weight', 900)

            var sums = [];
            // take each object and subtract it from the new object
            subset.forEach(function(trainingdigit, digit_idx) {
              var pairs = _.zip(_.values(trainingdigit), _.values(newdigit))
              
              var sum = _.reduce(pairs, function(memo, num){ return memo + Math.pow(num[0] - num[1], 2); }, 0);
              sums.push(sum)
              // shift the group down and spit out a value
              distancesGroup.append("svg:text")
                  .attr('class', 'distance-text')
                  .attr('id', 'distance-' + digit_idx)
                  .text(Math.round(sum))     
            })

            distancesGroupDefaults();
            var subset_nn = _.indexOf(sums, _.min(sums))
          });
        })

      }

      var secondaryOffset = 30;
      var newDigitDefaults = function() {
        d3.selectAll('#newdigitvalues_header')
          .text('New observation')
          .style('font-weight', 900)
          .attr('fill', red)
          .style('fill-opacity', 1e-6)

      var newDigitGroup = svg.selectAll('.newdigitgroup')
            .attr("transform", "translate(0," + secondaryOffset + ")")

        newDigitGroup.selectAll(".pixelvalue")
            .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
            .attr("y", 12)
            .text(function(d) { return Math.round(d * 10)/10 })
            .style('fill-opacity', 1e-6)
            .style('fill', red)
            .style('font-weight', 900)
            .style('font-size', '7px')

        newDigitGroup.selectAll('.pixel')
          .attr("width", pixelsize)
          .attr("height", pixelsize)
          .attr("x", function(d,i) {return pixelscale(i%16) + imgwidth*subset_size;})
          .attr("y", function(d,i) {return pixelscale(Math.floor(i/16))+trainingGroupOffset;})
          .style("fill", function(d) {return redwhitescale(d)})         
          .style('fill-opacity', 1e-6)
      }

      var trainingGroupOffset = 50
      var trainingGroupDefaults = function() {
          d3.select('.trainingSetGroup')
            .attr("transform", function(d) { return "translate(0," + (trainingGroupOffset+secondaryOffset) + ")"; })

          var digitGroups = d3.selectAll('.digit_group')
          digitGroups.each(function(group, idx) {
            d3.select(this).selectAll(".pixel")
              .attr("class", "pixel group-" + idx)
              .attr("width", pixelsize)
              .attr("height", pixelsize)
              .attr("x", function(d,i) { return idx*imgwidth  + pixelscale(i%16);})
              .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
              .style('fill-opacity', 1e-6);
         })
      }

      var pixelValueDefaults = function() {
          var digitGroups = d3.selectAll('.digit_group')
          digitGroups.each(function(group, idx) {
            d3.select(this).selectAll(".pixelvalue")
                .attr("class", "pixelvalue")
                .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
                .attr("y", function(d,i) { return pixelscale(idx*2.5) + 5; })
                .text(function(d) { return Math.round(d * 10)/10 })
                .style('fill-opacity', 1e-6)
                .style('font-size', '1px');
         }) 
      }

      var distancesGroupOffset = imgwidth*2-10
      var distancesGroupDefaults = function() {
        d3.selectAll('#distances_group')
          .attr("transform", function(d) { return "translate(0," + (distancesGroupOffset+trainingGroupOffset) + ")"; })

        d3.selectAll('#distance-header')
          .text('Distance from new observation:')
          .attr('x', 0)
          .attr('y', 0)
          .style('font-size', '12px')
          .style('fill', yellow)
          .style('font-weight', 9000)
          .style("fill-opacity", 1e-6);

        d3.selectAll('.distance-text')
          .attr('x', 0)
          .attr("y", function(d,i) { return pixelscale(i*2.5)-(trainingGroupOffset)-secondaryOffset })
          .style('font-size', '7px')
          .style('fill', black)
          .style('font-weight', 100)
          .style("fill-opacity", 1e-6); 
      }

      var drawTraining = function(delay) {
        var digitgroups = d3.selectAll('.digit_group')

        digitgroups.each(function(group, groupidx) {
            d3.selectAll('.group-' + groupidx).transition()
                .delay(delay)
                .duration(1000)
                .attr("x", function(d,i) {return groupidx*imgwidth + pixelscale(i%16);})
                .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
                .style('fill', function(d) { return blackwhitescale(d)})
                .style('fill-opacity', 1);
            });        
      }

      var dur = 10
      var drawPixelValueVectors = function() {
        subset = d3.selectAll('.digit_group')
        subset.each(function(digit, subset_idx) {
          d3.select(this).selectAll('.pixel').transition()
            .delay(function(d,pix) {return dur*(pix+1)})
            .duration(dur)
            .ease('linear')
            .style('fill', function(d) { return blackwhitescale(d) })
            .attr('x', function(d,i) { return(vectorscale(i)) })
            .attr('y', function(d,i) { return(pixelscale(subset_idx)) })
        });            
      }

      var drawNewDigitValues = function() {
        var newdiggroup = d3.selectAll('.newdigitgroup')
        var subset = d3.selectAll('.digit_group')

        newdiggroup.selectAll(".pixelvalue")
            .transition()
            .duration(1000)
            .style('fill-opacity',1)
            .style('font-size', '7px')
       
        d3.selectAll("#newdigitvalues_header")
            .transition()
            .duration(1000)
            .style('fill-opacity',1) 
      }

      var writeDistances = function() {
          d3.selectAll('#distance-header').transition()
            .delay(3000)
            .duration(1000)
            .style('fill-opacity', 1)

          d3.selectAll('.distance-text').transition()
            .delay(2000)          
            .duration(1000)
            .style('fill-opacity', 1)
            .transition()
              .duration(1000)
              .attr('y', 20)
            .transition()
              .duration(1000)
              .attr('x', function(d,i) { return i*imgwidth+13 })
            .transition()
              .duration(1000)
              .style('font-size', '12px')       
      }
     

      var lastScrollTop = 0;
      var st = 0;
      $(window).scroll(function(event){
         st = $(this).scrollTop();
      });
      graphScroll()
          .graph(d3.selectAll('#graph'))
          .container(d3.select('#container'))
        .sections(d3.selectAll('#sections > div'))
        .on('active', function(i){
          if (i == 0) { activateSectionOne() }
          if (i == 1 && st > lastScrollTop) { activateSectionTwo() }
          if (i == 2 && st > lastScrollTop) { activateSectionThree() }
          if (i == 3 && st > lastScrollTop) { activateSectionFour() }
          if (i == 4 && st > lastScrollTop) { activateSectionFive() }
          if (i == 5 && st > lastScrollTop) { activateSectionSix() }
          if (i == 6 && st > lastScrollTop) { activateSectionSeven() }
          if (i == 7 && st > lastScrollTop) { activateSectionEight() }
          if (i == 8 && st > lastScrollTop) {
            d3.selectAll('#section-9 div.button').attr('class','button button-active')            
          }
          lastScrollTop = st;
        }) 

        var activateSectionOne = function() {
          d3.selectAll('#graph').transition().duration(1000)
            .style('top','460px')        
          setup()
          d3.selectAll('#section-1 div.button').transition()
            .delay(1000)
            .attr('class','button button-active')
        }

        var activateSectionTwo = function() {
          d3.selectAll('#graph').transition().duration(1000)
            .style('top','160px')          
          pixelValueDefaults();
          drawPixelValueVectors();
          d3.selectAll('#section-2 div.button')
            .transition()
            .delay(dur*256).attr('class','button button-active')
        }

        var activateSectionThree = function() {
          pixelValueDefaults();

          d3.selectAll('.digit_group').selectAll('.pixel')
            .transition()
              .delay(function(d,pix) {return dur*pix})
              .duration(500)
              .ease('linear')
              .style('fill-opacity',1e-6)          
          d3.selectAll('.digit_group').selectAll('.pixelvalue')
            .transition()
              .delay(1000)
              .duration(1000)
              .ease('linear')
              .style('fill-opacity',1)
              .style('font-size', '7px')

          d3.selectAll('#section-3 div.button')
            .transition()
            .delay(2000).attr('class','button button-active')
        }        

        var activateSectionFour = function() {
          d3.selectAll('.trainingSetGroup')
            .transition()
            .duration(1000)
            //.attr("transform", function(d) { return "translate(0," + 0 + ")"; })
          drawNewDigitValues();

          d3.selectAll('#section-4 div.button')
            .transition()
            .delay(1000)
            .attr('class','button button-active')
        }

        var activateSectionFive = function() {
          d3.selectAll('.digit_group').selectAll('text').transition()
            .duration(2000)
            .attr('x', 0)
            .style('fill-opacity', 1e-6)

        trainingGroupDefaults();

        d3.selectAll('#distances_group')
          .attr("transform", function(d) { return "translate(0," + (trainingGroupOffset + distancesGroupOffset) + ")"; })

          writeDistances();
          drawTraining(5000);

          d3.selectAll('#section-5 div.button').transition()
            .delay(6000)
            .attr('class','button button-active')           
        }

        var activateSectionSix = function() {
          var distances = _.map(d3.selectAll('.distance-text')[0], function(a) { return +d3.select(a).text() })
          var magic = _.indexOf(distances, _.min(distances))
          d3.selectAll('.group-' + magic).transition()
              .delay(1000)   
              .duration(1000)
              .ease('linear')
              .style('fill', function(d) { return yellowwhitescale(d) });

          d3.selectAll('#distance-' + magic).transition()
            .delay(1000)
            .duration(1000)
            .ease('linear')
            .style('fill', yellow)
            .style('font-weight', 900)

            // plot the new digit
            d3.selectAll('.newdigitgroup').selectAll('.pixel')
              .transition()
              .delay(1000)
              .duration(1000)
              .style('fill-opacity', 1)

          d3.selectAll('#section-6 div.button').transition()
            .delay(2000)
            .attr('class','button button-active') 
        }

        var valueline = d3.svg.line()
          .interpolate("basis")
          .x(function(d) { return pixelscale(d[0]) })
          .y(function(d) { return pixelscale(Math.abs(d[1])) });

        d3.selection.prototype.moveToFront = function() {
          return this.each(function(){
            this.parentNode.appendChild(this);
          });
        };

        var activateSectionSeven = function() {
          newDigitDefaults();
          trainingGroupDefaults();
          pixelValueDefaults();
          distancesGroupDefaults();

          drawTraining(0);

          var pathsGroup = d3.selectAll('.pathsGroup')
          pathsGroup.moveToFront()
          d3.json('data/digit-paths.json', function(data) { 
            data.forEach(function(path, idx) {
              var label = path.label[0]            
              var digitpath = pathsGroup.append("path")
                .attr("d", valueline(path.path))
                .attr('class', 'highlighted-digit')
                .attr('transform', function(d) {
                  // find in subset where label matches
                  var labels = _.map(d3.selectAll('.digit_group')[0], function(a) { return +d3.select(a).attr('data-label') })
                  var i = _.indexOf(labels, label)
                  return 'translate(' + i*imgwidth + ', ' + secondaryOffset + ')'
                })
                .attr("stroke", red)
                .attr('stroke-width', 1.5)
                .attr("fill", "none") 

              var totalLength = digitpath.node().getTotalLength();

              digitpath.attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                  .delay(1000)
                  .duration(3000)
                  .ease("linear")
                  .attr("stroke-dashoffset", 0);             
            })
          })

          d3.selectAll('.digit_group .pixel').transition()
            .delay(4000).duration(1000).style('fill-opacity', 1e-6)

          d3.selectAll('#section-7 div.button').transition()
            .delay(5000)
            .attr('class','button button-active')        
        }

        var activateSectionEight = function() {
          d3.selectAll('rect').remove()
          d3.selectAll('g').remove()
          d3.selectAll('path').remove()
          d3.selectAll('text').remove()

          d3.selectAll('#section-8 div.button').transition()
            .delay(1000)
            .attr('class','button button-active')         
        }
    </script>
  </footer>
</html>

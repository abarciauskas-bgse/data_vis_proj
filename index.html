<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>D3: A starting point for interactivity</title>
    <script type="text/javascript" src="js/d3.v3.js"></script>
    <script type="text/javascript" src="js/underscore.js"></script>
    <script type="text/javascript" src="js/graph-scroll.js"></script>
    <!-- https://1wheel.github.io/graph-scroll/ -->
    <style type="text/css">
      body{
        width: 960px;
        height: 1000px;
        margin: 0px auto;
        background-color: '#E1E3D8';
        color: '#1A1A1A';
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      }

      #container, #container2{
        position: relative;
        width: 100%;
        overflow: auto;
      }

      #sections, #sections2{
        float: left;
      }

      #sections > div, #sections2 > div{
        background: white;
        opacity: .2;
        margin-bottom:120px;
      }

      #sections > div.graph-scroll-active, #sections2 > div.graph-scroll-active{
        opacity: 1;
      }


      #graph, #graph2{
        position: fixed;
        top: 220px;
      }

      #graph.graph-scroll-fixed, #graph2.graph-scroll-fixed{
        position: fixed;
        top: 160px;
      }

      #graph.graph-scroll-below, #graph2.graph-scroll-below {
        position: absolute;
        bottom: 0px;
      }

      h1 {
        margin: 50px;
      }

      h1, h3{
        text-align: center;
      }

      .mono{
        font-family: monospace;
      }

      div.section {
        height: 200px;
      }

      text.pixelvalue {
        font-size: 1px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <h1>Classification of MNIST Hand-Drawn Digits</h1>
    <div id='container'>
        <div id='sections'>
          <div class='section'><b>The image classification challenge:</b> Many machine learning tasks are concerned with classification. A common example is classifying images, whether the images be a photo of a cat or a hand-written digit. Converting hand-writing to computer-readable characters has many useful applications; for example, parsing a doctor's hand-written notes for electronic storage and future analysis.</div>
          <div class='section'>
            <p>But computers are simple creatures and it's hard for them to understand an image. Images have to be decomposed into lists of numeric values.</p>
            <p>A large set of examples is often required to train a classifier. These lists and their labels are the <b>training data</b> in classification tasks.</p>
          </div>
          <div class='section'>When a <span style="color: #F12A1B;">new object</span> needs to be classified, classification methods use the training data to determine which class is most likely for the new data. A classic and intuitive classification method is called <b>nearest-neighbors classification</b>. When an unknown image needs to be classified, it is compared to a training set. For each item in the training set, the new image is given a <b>distance score</b>. Those items in the training set which are "closest" to the new image are used to classify the new image.</div>


          <div class='section'>Then we can figure out which class it is.</div>
        </div>

        <div id='graph'></div>
    </div>
  </body>

  <footer>
    <script type="text/javascript">
      //Width and height
      var w = 960;
      var h = 200;
      
      //Create SVG element
      var svg = d3.select("#graph")
            .append("svg").attr({width: w, height: h})

      var pixelsize = 3.85
      var numpixels = 255
      var imgwidth = pixelsize*16
      var subset_size = 8

      var pixelscale = d3.scale.linear()
        .domain([0,16])
        .range([0,imgwidth]);

      var vectorscale = d3.scale.linear()
        .domain([0,255])
        .range([0,numpixels*pixelsize]);

      var black = '#1A1A1A'
      var blackwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([black,'white']);

      var red = '#F12A1B'
      var redwhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([red,'white']);

      var blue = '#0AB3A4'
      var bluewhitescale = d3.scale.linear()
        .domain([-1,1])
        .range([blue,'white']);

      var deactiveOtherSections = function(activesection) {
        d3.selectAll("rect").transition();
        d3.selectAll("text").transition();
      }

      var activateSectionOne = function(digits) {
        deactiveOtherSections(0)
        var digitgroups = d3.selectAll('.digit_group')

        digitgroups[0].forEach(function(group, groupidx) {
          d3.selectAll('.group-' + groupidx).transition()     
              .duration(1000)
              .ease('linear')
              .attr("x", function(d,i) {return groupidx*imgwidth + pixelscale(i%16);})
              .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
              .style('fill-opacity', 1);
            });
      }

      var activateSectionTwo = function() {
        deactiveOtherSections(1)
        subset = d3.selectAll('.digit_group')

        subset.each(function(digit, subset_idx) {
          pixels = d3.select(this).selectAll('.pixel')

          d3.select(this).selectAll('.pixel').transition()
              .delay(function(d,pix) {return 10*(pix+1)})
              .duration(10)
              .ease('linear')
              .attr('x', function(d,i) { return(vectorscale(i)) })
              .attr('y', function(d,i) { return(pixelscale(subset_idx)) })

          d3.select(this).selectAll('.pixel').transition()
            .delay(10*256)
            .duration(1000)
            .ease('linear')
            .style('fill-opacity',1e-6)

            d3.select(this).selectAll('.pixelvalue').transition()
              .delay(10*256)
              .duration(1000)
              .ease('linear')
              .style('fill-opacity',1)
              .style('font-size', '7px')

        });        
      }

      var activateSectionThree = function() {
        deactiveOtherSections(2)
        var newdiggroup = d3.selectAll('.newdigitgroup')
        var subset = d3.selectAll('.digit_group')

        newdiggroup.selectAll(".pixelvalue")
            .transition()
            .duration(1000)
            .style('fill-opacity',1)
            .style('font-size', '7px')

        subset.each(function(trainingdigit, digit_idx) {
          texts = d3.select(this).selectAll('text')
          texts.each(function(t) {
            d3.select(this).transition()
              .duration(1000)
              .transition()
                .delay(1000)
                .attr('x', 0)
              .transition()
                .delay(2000)
                .duration(1000)
                .style('fill-opacity', 1e-6)

          })
        })

        d3.selectAll('#distance-header').transition()
          .delay(3000)
          .duration(500)
          .style('fill-opacity', 1)

        var texts = d3.selectAll('.distance-text')

        texts.transition()
          .delay(3000)
          .duration(500)
          .style('fill-opacity', 1)
          .transition()
            .duration(1000)
            .attr('y', function(d, i) { return subset_size*10 + pixelscale(i*2.25) + 30 })
            .style('fill-opacity', 1)                    
      }

      var activateSectionFour = function(subset, subset_nn) {
        activateSectionOne(subset)
        var digitgroups = d3.selectAll('.digit_group')
        digitgroups[0].forEach(function(group, groupidx) {
          if (groupidx == subset_nn) {
            d3.selectAll('.group-' + groupidx).transition()
                .delay(1000)   
                .duration(1000)
                .ease('linear')
                .style('fill-opacity', 1)
                .attr("x", function(d,i) {return groupidx*imgwidth + pixelscale(i%16);})
                .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
                .style('fill', function(d) { return bluewhitescale(d) });
              };
          })
      }

      // load the data
      d3.csv("data/MNIST_training.csv", function(data) {
        svg.append('svg:text').text('Training Set')
          .style('fill',black)
          .attr('y', '12px')

        // we don't need all the data
        // TODO: Randomize?        
        subset = data.slice(0,subset_size)
        newdigit = data[11]
        subset.map(function(d) {
          _.map(d, function(v, k) { d[k] = +v })
        })

        _.map(newdigit, function(v,k) {
          newdigit[k] = +v
        })

        digitGroup = svg.append("svg:g")
          .attr('class', 'newdigitgroup')
          .attr('id', 'newdigit_' + newdigit.label)
          .attr("transform", function(d) { return "translate(0," + subset_size*10 + ")"; })

        digitGroup.selectAll(".pixelvalue")
            .data(_.values(newdigit))
          .enter().append("text")
            .attr("class", "pixelvalue")
            .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
            .attr("y", 12)
            .text(function(d) { return Math.round(d * 10)/10 })
            .style('fill-opacity', 1e-6)
            .style('fill', red)
            .style('font-size', '7px')

        // Put digits, numeric values and new digit on the page
        // when certain sections are active animate in and out of view
        //
        // Plot each from the subset
        // for each object, append a group to svg
        // and then plot each point from the digit
        subset.forEach(function(digit, idx) {
          digitGroup = svg.append("svg:g")
            .attr('class', 'digit_group')
            .attr('id', 'digit' + idx + '_' + digit.label)
            .attr("transform", function(d) { return "translate(0," + 20 + ")"; })

          digitGroup.selectAll(".pixel")
              .data(_.values(digit).slice(0,256))
            .enter().append("rect")
              .attr("class", "pixel group-" + idx)
              .attr("width", pixelsize)
              .attr("height", pixelsize)
              .attr("x", function(d,i) {return idx*imgwidth  + pixelscale(i%16);})
              .attr("y", function(d,i) {return pixelscale(Math.floor(i/16));})
              .style("fill", function(d) { return blackwhitescale(d) })
              .style('fill-opacity', 1e-6);

          digitGroup.selectAll(".pixelvalue")
              .data(_.values(digit).slice(0,256))
            .enter().append("text")
              .attr("class", "pixelvalue")
              .attr('x', function(d, point_idx) { return(vectorscale(point_idx)*4)})
              .attr("y", function(d,i) { return pixelscale(idx*2.25); })
              .text(function(d) { return Math.round(d * 10)/10 })
              .style('fill-opacity', 1e-6);
        });

        svg.append('svg:text')
          .attr('id','distance-header')
          .text('Distance from new observation:')
          .attr('x', 0)
          .attr('y', subset_size*10 + 20)
          .style('font-size', '7px')
          .style('fill', red)
          .style("fill-opacity", 1e-6);

        var sums = [];
        // take each object and subtract it from the new object
        subset.forEach(function(trainingdigit, digit_idx) {
          var pairs = _.zip(_.values(trainingdigit), _.values(newdigit))
          
          var sum = _.reduce(pairs, function(memo, num){ return memo + Math.pow(num[0] - num[1], 2); }, 0);
          sums.push(sum)
          // shift the group down and spit out a value
          var digitGroup = svg.selectAll('#digit' + digit_idx + '_' + trainingdigit.label)   
          svg.append("svg:text")
              .attr('class', 'distance-text')
              .attr('id', 'distance-' + digit_idx)
              .text(Math.round(sum))
              .attr('x', 0)
              .attr('y', pixelscale(digit_idx*2.25)+12)
              .style('font-size', '7px')
              .style('fill', black)
              .style("fill-opacity", 1e-6);          
          
        })

        var subset_nn = _.indexOf(sums, _.min(sums))

        graphScroll()
            .graph(d3.selectAll('#graph'))
            .container(d3.select('#container'))
          .sections(d3.selectAll('#sections > div'))
          .on('active', function(i){
            if (i == 0) { activateSectionOne(subset) }
            if (i == 1) { activateSectionTwo() }
            if (i == 2) { activateSectionThree(newdigit, subset) }
            if (i == 3) { activateSectionFour(subset, subset_nn) }
          })
      });
    </script>
  </footer>
</html>